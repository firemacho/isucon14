# 基本開発手順

## 1. mainブランチから各自featureブランチを切って開発
- ローカルもしくは実際のサーバで作業する
  - ローカルに動作環境は作らない（コードの修正のみ）
  - 動作確認しながら開発を行いたい場合は実際のサーバで作業する
    - 実際のサーバで作業する時は、作業が被る可能性があるので声を掛け合う

- goのソースコードを編集した場合、ソースコードのあるディレクトリで `go vet` を実施すると静的解析を行ってくれるので便利<br>make applyの前に実行するとよい<br>（必ずしも全てのメッセージに対応する必要はない）

- /etc配下のファイルを編集する場合は、s1, s2, s3の全てのディレクトリ配下のファイルを編集する必要があることに注意<br>
例えば、s1/etc配下のファイルを編集し、s2/etc配下とs3/etc配下のファイルを同じ内容に上書きしたい場合は以下を実行する
  ```
  cp -r s1/etc/* s2/etc/ 
  cp -r s1/etc/* s3/etc/
  ```
  ★ イケてないのでできれば改善したい

- サーバ構成を変更する（起動していたサービスを停止する／停止していたサービスを起動する）場合は、[config.sh](../config.sh)のSERVER_SERVICESを修正する<br>
※ before-bench.shが、これに基づき必要なサービスの起動・不要なサービスの停止を行う

## 2. ベンチマーク実行準備

## 2-1. 変更対象が1台のみの場合
変更対象のサーバが、現在作業を行っている1台のみの場合、以下手順により簡単に（git pushを経ることなく）ベンチマークの実行が可能。<br>
※ ベンチマークがきちんと実行できることを確認後にpushすればよい

必要に応じて、あらかじめcommit後、最新のmainをマージ<br>
（必要ない場合は、commitせずに、ソースコードを編集した時点で`make apply`に進んでも良い）
```
git fetch
git merge origin/main
```

ベンチマーク実行準備
```
make apply
```
以下が行われる
- ログローテーション
- アプリのビルド
- /home/<SERVER_ID> 配下のconfの適用
- 各サービスの再起動 ※本来は起動する必要のないサービスも含め全てのサービスが起動する

## 2-2. 変更対象が複数台の場合
複数台の変更を行う場合は、GitHubを経由して各サーバに修正を適用する。

以下のように最新のmainをマージしてからGitHubにpushする
```
git fetch
git merge origin/main
git push origin feature/xxx
```

ローカル（Git Bash）でbefore-bench.shを実行する<br>
※ config.shを修正した場合、git pullしてローカルにその内容を反映する必要があるので注意
```
# 全サーバを対象に実行したい場合
./before-bench.sh -b <ブランチ名> all

# 一部のサーバ（以下例ではs1とs2）を対象に実行したい場合（他の人が作業中のサーバに手を加えないようにしたい場合）
./before-bench.sh -b <ブランチ名> s1 s2
```
以下が行われる
- 対象サーバで指定したブランチをcheckout
- ログローテーション
- アプリのビルド
- 設定変更の適用（必要なサービスのみ起動する）

## 3. ベンチマークの実行
指定された方法でベンチマークを実行する

## 4. profile.shの実行
ローカル（Git Bash）で実行する
```
# 全サーバを対象に実行したい場合
./profile.sh all

# 一部のサーバ（以下例ではs1とs2）を対象に実行したい場合
./profile.sh s1 s2
```
以下が行われる
- 定期的にtopを行いdiscordに結果を送信
- cpu.pprofの取得

## 5. after-bench.shの実行
ローカル（Git Bash）で実行する
```
# 全サーバを対象に実行したい場合
./after-bench.sh all

# 一部のサーバ（以下例ではs1とs2）を対象に実行したい場合
./after-bench.sh s1 s2
```
以下が行われる
- nginxログ解析
- mysqlのスロークエリ解析
- cpu.pprofの解析
- 解析結果のdiscordへの投稿

※ cpu.pprofの解析結果をブラウザで見るためには、ポートフォワードを行うことが必要<br>
- ローカルで以下のようにコマンドを実行する（タイムアウトした場合は再度実行する）
    ```
    ssh -f -N -L <ローカルのポート>:localhost:8090 <sshユーザ>@<sshするホスト名>

    # 例：server1の解析結果をlocalhost:8080で見る場合
    ssh -f -N -L 8080:localhost:8090 isucon@server1
    ```

## 7. mainブランチへのマージ・Issuesへのスコアの記入
開発内容に問題がなければ、開発したブランチをmainブランチへマージし、Issuesへスコアを記入する
